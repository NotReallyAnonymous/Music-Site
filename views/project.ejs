<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= projectName ? `${projectName} | Music Projects` : "Music Projects" %></title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar" data-sidebar>
        <div class="sidebar__header">
          <div>
            <p class="sidebar__eyebrow">Music Projects</p>
            <h1 class="sidebar__title">Launchbay Records</h1>
          </div>
          <button class="sidebar__close" type="button" data-sidebar-toggle aria-label="Toggle project list">☰</button>
        </div>
        <% if (projects.length === 0) { %>
          <p class="sidebar__empty">No projects yet. Add folders in <code>music</code>.</p>
        <% } else { %>
          <nav class="sidebar__nav">
            <% projects.forEach((project) => { %>
              <a
                class="sidebar__link <%= projectName === project.name ? 'is-active' : '' %>"
                href="/project/<%= encodeURIComponent(project.name) %>"
              >
                <span><%= project.name %></span>
                <span class="sidebar__meta">Latest demo</span>
              </a>
            <% }) %>
          </nav>
        <% } %>
      </aside>
      <main class="main">
        <header class="main__header">
          <div>
            <h2 class="main__title"><%= projectName || "No project selected" %></h2>
            <p class="main__subtitle">
              <% if (projectName) { %>
                Latest demo and previous versions ready to play.
              <% } else { %>
                Drop .wav files into <code>music</code> to populate the sidebar.
              <% } %>
            </p>
          </div>
          <div class="main__actions">
            <button class="ghost-button" type="button" data-sidebar-toggle aria-label="Toggle project list">☰</button>
            <% if (projectName) { %>
              <button
                class="primary-button icon-button"
                type="button"
                data-share-button
                aria-label="Copy page link"
                title="Copy page link"
              >
                <span class="sr-only">Copy page link</span>
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path
                    d="M10.5 13.5H9a4.5 4.5 0 0 1 0-9h1.5a1 1 0 0 1 0 2H9a2.5 2.5 0 0 0 0 5h1.5a1 1 0 0 1 0 2Zm4.5 6H13.5a1 1 0 0 1 0-2H15a2.5 2.5 0 0 0 0-5h-1.5a1 1 0 0 1 0-2H15a4.5 4.5 0 0 1 0 9Zm-6-7.5h6a1 1 0 0 1 0 2H9a1 1 0 0 1 0-2Z"
                  />
                </svg>
              </button>
            <% } %>
          </div>
        </header>
        <section class="content">
          <% if (!projectName) { %>
            <div class="empty-state">
              <p>No projects yet. Create a folder inside <code>music</code> to get started.</p>
            </div>
          <% } else if (demos.length === 0) { %>
            <div class="empty-state">
              <p>No demo files yet. Add .wav files to <code>music/<%= projectName %></code>.</p>
            </div>
          <% } else { %>
            <section class="latest-demo">
              <h3>Latest demo</h3>
              <div class="demo-card demo-card--featured">
                <div>
                  <p class="demo-title"><%= projectName %></p>
                  <p class="demo-version">version <%= demos[0].displayName %></p>
                  <p class="demo-modified">Modified <%= demos[0].modifiedAtLabel %></p>
                </div>
                <audio
                  controls
                  preload="metadata"
                  src="/music/<%= encodeURIComponent(projectName) %>/<%= encodeURIComponent(demos[0].name) %>"
                ></audio>
              </div>
            </section>
            <% if (demos.length > 1) { %>
              <section class="previous-demos">
                <h3>Previous versions</h3>
                <div class="demo-grid">
                  <% demos.slice(1).forEach((demo) => { %>
                    <div class="demo-card">
                      <div>
                        <p class="demo-title"><%= projectName %></p>
                        <p class="demo-version">version <%= demo.displayName %></p>
                        <p class="demo-modified">Modified <%= demo.modifiedAtLabel %></p>
                      </div>
                      <audio
                        controls
                        preload="none"
                        src="/music/<%= encodeURIComponent(projectName) %>/<%= encodeURIComponent(demo.name) %>"
                      ></audio>
                    </div>
                  <% }) %>
                </div>
              </section>
            <% } %>
          <% } %>
        </section>
      </main>
    </div>
    <script>
      const events = new EventSource("/events");
      events.addEventListener("message", (event) => {
        if (event.data === "reload") {
          window.location.reload();
        }
      });

      const sidebar = document.querySelector("[data-sidebar]");
      document.querySelectorAll("[data-sidebar-toggle]").forEach((button) => {
        button.addEventListener("click", () => {
          sidebar.classList.toggle("is-open");
        });
      });

      const shareButton = document.querySelector("[data-share-button]");
      if (shareButton) {
        shareButton.addEventListener("click", async () => {
          const shareUrl = window.location.href;
          try {
            await navigator.clipboard.writeText(shareUrl);
            shareButton.classList.add("is-confirmed");
            shareButton.setAttribute("aria-label", "Link copied");
            shareButton.setAttribute("title", "Link copied");
            setTimeout(() => {
              shareButton.classList.remove("is-confirmed");
              shareButton.setAttribute("aria-label", "Copy page link");
              shareButton.setAttribute("title", "Copy page link");
            }, 2000);
          } catch (error) {
            console.warn("Unable to copy link", error);
            window.prompt("Copy this link", shareUrl);
          }
        });
      }

    </script>
  </body>
</html>
