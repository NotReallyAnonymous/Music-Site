<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= projectName ? `${projectName} | Music Projects` : "Music Projects" %></title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body data-project-name="<%= projectName || "" %>">
    <div class="app-shell">
      <aside class="sidebar" data-sidebar>
        <div class="sidebar__header">
          <div>
            <p class="sidebar__eyebrow">Music Projects</p>
            <h1 class="sidebar__title">Launchbay Records</h1>
          </div>
          <div class="sidebar__header-actions">
            <button
              class="icon-button ghost-button"
              type="button"
              data-new-project
              data-auth-control
              aria-label="Create new project"
            >
              ＋
            </button>
            <button class="sidebar__close" type="button" data-sidebar-toggle aria-label="Toggle project list">☰</button>
          </div>
        </div>
        <% if (projects.length === 0) { %>
          <p class="sidebar__empty">No projects yet. Add folders in <code>music</code> or hit the + button.</p>
        <% } else { %>
          <nav class="sidebar__nav">
            <% projects.forEach((project) => { %>
              <div class="sidebar__item">
                <a
                  class="sidebar__link <%= projectName === project.name ? 'is-active' : '' %>"
                  href="/project/<%= encodeURIComponent(project.name) %>"
                >
                  <span><%= project.name %></span>
                  <span class="sidebar__meta">Latest demo</span>
                </a>
                <div class="menu" data-menu>
                  <button class="menu__trigger" type="button" data-menu-trigger data-auth-control aria-label="Project options">⋮</button>
                  <div class="menu__content">
                    <button class="menu__item" type="button" data-action="rename-project" data-project="<%= project.name %>">
                      Rename
                    </button>
                    <% if (!project.hasDemos) { %>
                      <button class="menu__item menu__item--danger" type="button" data-action="delete-project" data-project="<%= project.name %>">
                        Delete
                      </button>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }) %>
          </nav>
        <% } %>
      </aside>
      <main class="main">
        <header class="main__header">
          <div>
            <h2 class="main__title"><%= projectName || "No project selected" %></h2>
            <p class="main__subtitle">
              <% if (projectName) { %>
                Latest demo and previous versions ready to play.
              <% } else { %>
                Drop .wav files into <code>music</code> to populate the sidebar.
              <% } %>
            </p>
            <p class="auth-status" data-auth-status></p>
          </div>
          <div class="main__actions">
            <button class="ghost-button ghost-button--mobile" type="button" data-sidebar-toggle aria-label="Toggle project list">☰</button>
            <% if (projectName) { %>
              <input class="sr-only" type="file" accept=".wav" data-upload-input />
              <button class="primary-button" type="button" data-upload-button data-auth-control>Upload demo</button>
              <button
                class="primary-button icon-button"
                type="button"
                data-share-button
                aria-label="Copy page link"
                title="Copy page link"
              >
                <span class="sr-only">Copy page link</span>
                <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
                <svg
                  width="800px"
                  height="800px"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  focusable="false"
                >
                  <path
                    d="M9.16488 17.6505C8.92513 17.8743 8.73958 18.0241 8.54996 18.1336C7.62175 18.6695 6.47816 18.6695 5.54996 18.1336C5.20791 17.9361 4.87912 17.6073 4.22153 16.9498C3.56394 16.2922 3.23514 15.9634 3.03767 15.6213C2.50177 14.6931 2.50177 13.5495 3.03767 12.6213C3.23514 12.2793 3.56394 11.9505 4.22153 11.2929L7.04996 8.46448C7.70755 7.80689 8.03634 7.47809 8.37838 7.28062C9.30659 6.74472 10.4502 6.74472 11.3784 7.28061C11.7204 7.47809 12.0492 7.80689 12.7068 8.46448C13.3644 9.12207 13.6932 9.45086 13.8907 9.7929C14.4266 10.7211 14.4266 11.8647 13.8907 12.7929C13.7812 12.9825 13.6314 13.1681 13.4075 13.4078M10.5919 10.5922C10.368 10.8319 10.2182 11.0175 10.1087 11.2071C9.57284 12.1353 9.57284 13.2789 10.1087 14.2071C10.3062 14.5492 10.635 14.878 11.2926 15.5355C11.9502 16.1931 12.279 16.5219 12.621 16.7194C13.5492 17.2553 14.6928 17.2553 15.621 16.7194C15.9631 16.5219 16.2919 16.1931 16.9495 15.5355L19.7779 12.7071C20.4355 12.0495 20.7643 11.7207 20.9617 11.3787C21.4976 10.4505 21.4976 9.30689 20.9617 8.37869C20.7643 8.03665 20.4355 7.70785 19.7779 7.05026C19.1203 6.39267 18.7915 6.06388 18.4495 5.8664C17.5212 5.3305 16.3777 5.3305 15.4495 5.8664C15.2598 5.97588 15.0743 6.12571 14.8345 6.34955"
                    stroke="#000000"
                    stroke-width="2"
                    stroke-linecap="round"
                  />
                </svg>
              </button>
            <% } %>
            <button class="ghost-button" type="button" data-auth-toggle>Unlock editing</button>
          </div>
        </header>
        <section class="content">
          <% if (!projectName) { %>
            <div class="empty-state">
              <p>No projects yet. Create a folder inside <code>music</code> to get started.</p>
            </div>
          <% } else if (demos.length === 0) { %>
            <div class="empty-state">
              <p>No demo files yet. Add .wav files to <code>music/<%= projectName %></code>.</p>
            </div>
          <% } else { %>
            <section class="latest-demo">
              <h3>Latest demo</h3>
              <div class="demo-card demo-card--featured">
                <div>
                  <p class="demo-title"><%= projectName %></p>
                  <p class="demo-version">version <%= demos[0].displayName %></p>
                  <p class="demo-modified">Modified <%= demos[0].modifiedAtLabel %></p>
                </div>
                <div class="demo-card__actions">
                  <audio
                    controls
                    preload="metadata"
                    src="/music/<%= encodeURIComponent(projectName) %>/<%= encodeURIComponent(demos[0].name) %>"
                  ></audio>
                  <div class="menu" data-menu>
                    <button class="menu__trigger" type="button" data-menu-trigger data-auth-control aria-label="Demo options">⋮</button>
                    <div class="menu__content">
                      <button
                        class="menu__item"
                        type="button"
                        data-action="rename-demo"
                        data-project="<%= projectName %>"
                        data-demo="<%= demos[0].name %>"
                      >
                        Rename
                      </button>
                      <button
                        class="menu__item menu__item--danger"
                        type="button"
                        data-action="delete-demo"
                        data-project="<%= projectName %>"
                        data-demo="<%= demos[0].name %>"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            <% if (demos.length > 1) { %>
              <section class="previous-demos">
                <h3>Previous versions</h3>
                <div class="demo-grid">
                  <% demos.slice(1).forEach((demo) => { %>
                    <div class="demo-card">
                      <div>
                        <p class="demo-title"><%= projectName %></p>
                        <p class="demo-version">version <%= demo.displayName %></p>
                        <p class="demo-modified">Modified <%= demo.modifiedAtLabel %></p>
                      </div>
                      <div class="demo-card__actions">
                        <audio
                          controls
                          preload="none"
                          src="/music/<%= encodeURIComponent(projectName) %>/<%= encodeURIComponent(demo.name) %>"
                        ></audio>
                        <div class="menu" data-menu>
                          <button class="menu__trigger" type="button" data-menu-trigger data-auth-control aria-label="Demo options">⋮</button>
                          <div class="menu__content">
                            <button
                              class="menu__item"
                              type="button"
                              data-action="rename-demo"
                              data-project="<%= projectName %>"
                              data-demo="<%= demo.name %>"
                            >
                              Rename
                            </button>
                            <button
                              class="menu__item menu__item--danger"
                              type="button"
                              data-action="delete-demo"
                              data-project="<%= projectName %>"
                              data-demo="<%= demo.name %>"
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </section>
            <% } %>
          <% } %>
        </section>
      </main>
    </div>
    <div class="modal" data-modal="new-project" aria-hidden="true">
      <div class="modal__backdrop" data-modal-close></div>
      <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="new-project-title">
        <h3 class="modal__title" id="new-project-title">Create new project</h3>
        <form data-new-project-form>
          <label class="field">
            <span class="field__label">Project name</span>
            <input class="field__input" type="text" name="name" required placeholder="New project" />
          </label>
          <label class="field">
            <span class="field__label">Short note</span>
            <textarea class="field__input" name="note" rows="3" placeholder="Rock, slow, somber"></textarea>
          </label>
          <div class="modal__actions">
            <button class="ghost-button" type="button" data-modal-close>Cancel</button>
            <button class="primary-button" type="submit">Create project</button>
          </div>
        </form>
      </div>
    </div>
    <div class="modal" data-modal="auth" aria-hidden="true">
      <div class="modal__backdrop"></div>
      <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
        <h3 class="modal__title" id="auth-modal-title" data-auth-title>Unlock editing</h3>
        <p class="modal__helper" data-auth-helper></p>
        <form data-auth-setup-form>
          <label class="field">
            <span class="field__label">New password</span>
            <input class="field__input" type="password" name="password" minlength="8" required />
          </label>
          <label class="field">
            <span class="field__label">Confirm password</span>
            <input class="field__input" type="password" name="confirm" minlength="8" required />
          </label>
          <div class="modal__actions">
            <button class="primary-button" type="submit">Set password</button>
          </div>
        </form>
        <form data-auth-login-form>
          <label class="field">
            <span class="field__label">Password</span>
            <input class="field__input" type="password" name="password" minlength="8" required />
          </label>
          <div class="modal__actions">
            <button class="primary-button" type="submit">Unlock editing</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      const events = new EventSource("/events");
      events.addEventListener("message", (event) => {
        if (event.data === "reload") {
          window.location.reload();
        }
      });

      const authModal = document.querySelector('[data-modal="auth"]');
      const authTitle = document.querySelector("[data-auth-title]");
      const authHelper = document.querySelector("[data-auth-helper]");
      const authStatus = document.querySelector("[data-auth-status]");
      const authToggleButton = document.querySelector("[data-auth-toggle]");
      const authControls = document.querySelectorAll("[data-auth-control]");
      const authSetupForm = document.querySelector("[data-auth-setup-form]");
      const authLoginForm = document.querySelector("[data-auth-login-form]");
      let authState = { configured: false, authenticated: false };

      const sidebar = document.querySelector("[data-sidebar]");
      document.querySelectorAll("[data-sidebar-toggle]").forEach((button) => {
        button.addEventListener("click", () => {
          sidebar.classList.toggle("is-open");
        });
      });

      const shareButton = document.querySelector("[data-share-button]");
      if (shareButton) {
        shareButton.addEventListener("click", async () => {
          const shareUrl = window.location.href;
          try {
            await navigator.clipboard.writeText(shareUrl);
            shareButton.classList.add("is-confirmed");
            shareButton.setAttribute("aria-label", "Link copied");
            shareButton.setAttribute("title", "Link copied");
            setTimeout(() => {
              shareButton.classList.remove("is-confirmed");
              shareButton.setAttribute("aria-label", "Copy page link");
              shareButton.setAttribute("title", "Copy page link");
            }, 2000);
          } catch (error) {
            console.warn("Unable to copy link", error);
            window.prompt("Copy this link", shareUrl);
          }
        });
      }

      const newProjectButton = document.querySelector("[data-new-project]");
      const newProjectModal = document.querySelector('[data-modal="new-project"]');
      const newProjectForm = document.querySelector("[data-new-project-form]");

      const openModal = (modal) => {
        if (!modal) return;
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
        const firstInput = modal.querySelector("input, textarea");
        if (firstInput) {
          firstInput.focus();
        }
      };

      const closeModal = (modal) => {
        if (!modal) return;
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
      };

      const setEditingLocked = (locked) => {
        document.body.classList.toggle("is-locked", locked);
        authControls.forEach((control) => {
          control.toggleAttribute("disabled", locked);
          control.setAttribute("aria-disabled", locked ? "true" : "false");
        });
      };

      const showAuthModal = (mode) => {
        if (!authModal) return;
        if (authSetupForm) {
          authSetupForm.style.display = mode === "setup" ? "block" : "none";
        }
        if (authLoginForm) {
          authLoginForm.style.display = mode === "login" ? "block" : "none";
        }
        if (authTitle) {
          authTitle.textContent = mode === "setup" ? "Set editing password" : "Unlock editing";
        }
        if (authHelper) {
          authHelper.textContent =
            mode === "setup"
              ? "Choose a password to unlock all editing actions on this device."
              : "Enter the password to unlock editing actions on this device.";
        }
        openModal(authModal);
        const focusTarget =
          mode === "setup" ? authSetupForm?.querySelector("input") : authLoginForm?.querySelector("input");
        if (focusTarget) {
          focusTarget.focus();
        }
      };

      const updateAuthUi = (state) => {
        authState = state;
        const locked = !state.authenticated;
        setEditingLocked(locked);
        if (authToggleButton) {
          authToggleButton.textContent = locked ? "Unlock editing" : "Lock editing";
        }
        if (authStatus) {
          if (!state.configured) {
            authStatus.textContent = "Editing locked. Set a password to enable edits.";
          } else if (!state.authenticated) {
            authStatus.textContent = "Editing locked. Enter your password to enable edits.";
          } else {
            authStatus.textContent = "Editing unlocked for this session.";
          }
        }
        if (locked) {
          showAuthModal(state.configured ? "login" : "setup");
        } else if (authModal) {
          closeModal(authModal);
        }
      };

      const fetchAuthStatus = async () => {
        try {
          const response = await fetch("/api/auth/status");
          const data = await response.json();
          updateAuthUi({ configured: Boolean(data.configured), authenticated: Boolean(data.authenticated) });
        } catch (error) {
          console.warn("Unable to fetch auth status", error);
        }
      };

      if (newProjectButton && newProjectModal) {
        newProjectButton.addEventListener("click", () => openModal(newProjectModal));
        newProjectModal.querySelectorAll("[data-modal-close]").forEach((button) => {
          button.addEventListener("click", () => closeModal(newProjectModal));
        });
      }

      if (authToggleButton) {
        authToggleButton.addEventListener("click", async () => {
          if (authState.authenticated) {
            try {
              await fetch("/api/auth/logout", { method: "POST" });
            } catch (error) {
              console.warn("Unable to log out", error);
            }
            fetchAuthStatus();
            return;
          }
          showAuthModal(authState.configured ? "login" : "setup");
        });
      }

      if (authSetupForm) {
        authSetupForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const formData = new FormData(authSetupForm);
          const password = formData.get("password").toString();
          const confirm = formData.get("confirm").toString();
          if (!password || password.length < 8) {
            alert("Password must be at least 8 characters.");
            return;
          }
          if (password !== confirm) {
            alert("Passwords do not match.");
            return;
          }
          try {
            const response = await fetch("/api/auth/setup", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password }),
            });
            if (!response.ok) {
              const data = await response.json().catch(() => ({}));
              alert(data.error || "Unable to set password.");
              return;
            }
            authSetupForm.reset();
            fetchAuthStatus();
          } catch (error) {
            console.warn("Unable to set password", error);
            alert("Unable to set password.");
          }
        });
      }

      if (authLoginForm) {
        authLoginForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const formData = new FormData(authLoginForm);
          const password = formData.get("password").toString();
          if (!password) {
            alert("Enter your password.");
            return;
          }
          try {
            const response = await fetch("/api/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password }),
            });
            if (!response.ok) {
              const data = await response.json().catch(() => ({}));
              alert(data.error || "Unable to authenticate.");
              return;
            }
            authLoginForm.reset();
            fetchAuthStatus();
          } catch (error) {
            console.warn("Unable to authenticate", error);
            alert("Unable to authenticate.");
          }
        });
      }

      if (newProjectForm) {
        newProjectForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const formData = new FormData(newProjectForm);
          const name = formData.get("name").toString().trim();
          const note = formData.get("note").toString().trim();

          if (!name) {
            alert("Please provide a project name.");
            return;
          }

          try {
            const response = await fetch("/api/projects", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, note }),
            });

            if (!response.ok) {
              const data = await response.json().catch(() => ({}));
              alert(data.error || "Unable to create project.");
              return;
            }

            const data = await response.json();
            window.location.href = `/project/${encodeURIComponent(data.projectName)}`;
          } catch (error) {
            console.warn("Unable to create project", error);
            alert("Unable to create project.");
          }
        });
      }

      const uploadButton = document.querySelector("[data-upload-button]");
      const uploadInput = document.querySelector("[data-upload-input]");
      const projectName = document.body.dataset.projectName;

      if (uploadButton && uploadInput && projectName) {
        uploadButton.addEventListener("click", () => uploadInput.click());
        uploadInput.addEventListener("change", async () => {
          const file = uploadInput.files[0];
          if (!file) return;
          const formData = new FormData();
          formData.append("demo", file);

          try {
            const response = await fetch(`/api/projects/${encodeURIComponent(projectName)}/upload`, {
              method: "POST",
              body: formData,
            });
            if (!response.ok) {
              const data = await response.json().catch(() => ({}));
              alert(data.error || "Unable to upload demo.");
              return;
            }
            window.location.reload();
          } catch (error) {
            console.warn("Unable to upload demo", error);
            alert("Unable to upload demo.");
          } finally {
            uploadInput.value = "";
          }
        });
      }

      const menus = document.querySelectorAll("[data-menu]");
      const closeMenus = () => {
        menus.forEach((menu) => menu.classList.remove("is-open"));
      };

      menus.forEach((menu) => {
        const trigger = menu.querySelector("[data-menu-trigger]");
        if (!trigger) return;
        trigger.addEventListener("click", (event) => {
          event.stopPropagation();
          const isOpen = menu.classList.contains("is-open");
          closeMenus();
          if (!isOpen) {
            menu.classList.add("is-open");
          }
        });
      });

      document.addEventListener("click", () => closeMenus());

      const requestJson = async (url, options) => {
        const response = await fetch(url, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        if (!response.ok) {
          const data = await response.json().catch(() => ({}));
          if (response.status === 401) {
            showAuthModal(authState.configured ? "login" : "setup");
          }
          throw new Error(data.error || "Request failed.");
        }
        return response.json().catch(() => ({}));
      };

      document.addEventListener("click", async (event) => {
        const actionButton = event.target.closest("[data-action]");
        if (!actionButton) return;

        const action = actionButton.dataset.action;
        const actionProject = actionButton.dataset.project;
        const actionDemo = actionButton.dataset.demo;

        try {
          if (action === "rename-project") {
            const name = window.prompt("Rename project", actionProject);
            if (!name) return;
            const data = await requestJson(`/api/projects/${encodeURIComponent(actionProject)}`, {
              method: "PUT",
              body: JSON.stringify({ name }),
            });
            window.location.href = `/project/${encodeURIComponent(data.projectName)}`;
          }

          if (action === "delete-project") {
            const confirmDelete = window.confirm("Delete this project?");
            if (!confirmDelete) return;
            await requestJson(`/api/projects/${encodeURIComponent(actionProject)}`, { method: "DELETE" });
            window.location.href = "/";
          }

          if (action === "rename-demo") {
            const name = window.prompt("Rename demo file", actionDemo);
            if (!name) return;
            await requestJson(
              `/api/projects/${encodeURIComponent(actionProject)}/demos/${encodeURIComponent(actionDemo)}`,
              {
                method: "PUT",
                body: JSON.stringify({ name }),
              }
            );
            window.location.reload();
          }

          if (action === "delete-demo") {
            const confirmDelete = window.confirm("Delete this demo file?");
            if (!confirmDelete) return;
            await requestJson(
              `/api/projects/${encodeURIComponent(actionProject)}/demos/${encodeURIComponent(actionDemo)}`,
              {
                method: "DELETE",
              }
            );
            window.location.reload();
          }
        } catch (error) {
          alert(error.message);
        }
      });

      fetchAuthStatus();
    </script>
  </body>
</html>
